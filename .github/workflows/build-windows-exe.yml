name: Build Windows EXE

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Source repo git ref to build
        required: false
        default: main

permissions:
  contents: read

jobs:
  build:
    name: Build - windows-latest
    runs-on: windows-latest
    steps:
      - name: Checkout source (SSH)
        uses: actions/checkout@v4
        with:
          repository: FuChuZhao/tokscale-private
          ref: ${{ inputs.ref }}
          ssh-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
          fetch-depth: 1
          persist-credentials: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build CLI
        run: bun run --cwd packages/cli build

      - name: Build executable
        run: bun --cwd packages/cli scripts/build-windows-exe.ts

      - name: Smoke test
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $tempHome = Join-Path $env:RUNNER_TEMP "tokscale-empty-home"
          New-Item -ItemType Directory -Force -Path $tempHome | Out-Null
          $env:USERPROFILE = $tempHome
          $env:HOME = $tempHome

          $exe = Join-Path $env:GITHUB_WORKSPACE "packages\\cli\\dist-exe\\tokscale.exe"
          for ($i = 0; $i -lt 10 -and -not (Test-Path $exe); $i++) { Start-Sleep -Seconds 1 }
          if (-not (Test-Path $exe)) { throw "Built exe not found: $exe" }

          & $exe pricing gpt-4o-mini --json --no-spinner | Out-Null
          & $exe models --json --no-spinner | Out-Null

      - name: Package artifact
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path dist | Out-Null

          $exe = Join-Path $env:GITHUB_WORKSPACE "packages\\cli\\dist-exe\\tokscale.exe"
          for ($i = 0; $i -lt 10 -and -not (Test-Path $exe); $i++) { Start-Sleep -Seconds 1 }
          if (-not (Test-Path $exe)) { throw "Built exe not found: $exe" }

          Copy-Item -Force $exe dist\\tokscale.exe
          Compress-Archive -Force -Path dist\\tokscale.exe -DestinationPath tokscale-windows-x64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tokscale-windows-x64
          path: tokscale-windows-x64.zip
          if-no-files-found: error
          retention-days: 1
